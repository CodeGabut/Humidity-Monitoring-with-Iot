<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
     html, body {
        height: 100%;
        margin: 0;
     }
     body {
        background: linear-gradient(#3aaac5,#4776e6) no-repeat center center fixed;
        background-size: cover;
        font-family: Arial, sans-serif;
     }
    .chart-wrapper {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
    }
    .chart-wrapper canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container mt-2">
    <div class="row justify-content-center">
      <div class="col-md-4">
        <div class="card shadow">
          <img src="/Fisika_Teoritik__Komputasi_dan_Instrumentasi__34_-removebg-preview.png" alt="" style="width: 50px;height: 50px; margin: 5px;">
          <div class="card-body text-center">
            <h5 class="card-title">Humidity Monitoring</h5>
            <div class="chart-wrapper mb-3">
              <canvas id="humidityChart"></canvas>
              <div class="value" >
                <i class="bi bi-droplet-fill" id="dropIcon" style="font-size: 100px; color: #50c1dd;padding-bottom: 20px;"></i>
              </div>
              <div class="value" id="humidityValue" style="color: aliceblue; text-shadow: 2px 2px 4px rgba(0,0,0,0.4);margin-top: 10px;">0%</div>
            </div>

            <!-- Hasil perhitungan horizontal -->
            <div class="d-flex justify-content-around mt-3">
              <p class="mb-1"><strong>AH:</strong> <span id="ahValue">21.3 g/m³</span></p>
              <p class="mb-1"><strong>Dew Point:</strong> <span id="dewValue">24 °C</span></p>
            </div>
            <div class="d-flex justify-content-around mt-3">
              <p class="mb-1"><strong>Temperature :</strong> <span id="tempValue">24 °C</span></p>
              <p class="mb-1 "><strong>Alarm set:</strong> <span id="alarmValue" ><%- typeof alarmValue != 'undefined' ? alarmValue : 80 %>%</span></p>
            </div>
             
            <form method="post"  action="/set_alarm">
            <div class="input-group input-group-sm mb-3 mt-3">
              <span class="input-group-text" id="inputGroup-sizing-sm">Change alarm value</span>
              <input type="text" name="alarm" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
            </div>
            <button type="submit" class="btn btn-primary" style="background-color: #3aaac5 !important;width: 100%;"><i class="bi bi-alarm"></i> Set the alarm</button>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Chart.js -->
  <script>
    const ctx = document.getElementById('humidityChart').getContext('2d');

    const humidityChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [0, 100],
          backgroundColor: ['#00c9ff', '#e0e0e0'],
          borderWidth: 0,
          cutout: '75%'
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false }
        }
      }
    });

    function updateHumidity(value,comparator) {

      console.log("ini di fungsi ");
console.log(value);



       let color = '#00c9ff'; 
       let color_backround = "#3aaac5"
  if (value.humidity > comparator) {
    color = '#ff4d4d';
    color_backround = '#ff4d4d';
  }

      humidityChart.data.datasets[0].data = [value.humidity, 100 - value.humidity];
      humidityChart.data.datasets[0].backgroundColor = [color, '#e0e0e0']
      humidityChart.update();
      document.body.style.background = `linear-gradient(${color_backround},#4776e6)`
      document.body.style.backgroundRepeat = "no-repeat";
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundAttachment = "fixed";
    
      document.getElementById("humidityValue").textContent = value.humidity + "%";
      document.getElementById("tempValue").textContent = value.temperature + "°C";

      // update ikon
  document.getElementById("dropIcon").style.color = color;

      // Hitung AH & Dew Point
      const T = value.temperature; 
      const RH = value.humidity; 
      const es = 6.112 * Math.exp((17.67 * T) / (T + 243.5));
      const e = RH/100 * es;
      const AH = (216.7 * e) / (T + 273.15);
      const gamma = Math.log(RH/100) + (17.67 * T) / (T + 243.5);
      const Td = (243.5 * gamma) / (17.67 - gamma);

      document.getElementById("ahValue").textContent = AH.toFixed(1) + " g/m³";
      document.getElementById("dewValue").textContent = Td.toFixed(1) + " °C";
    }


  </script>

 <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    socket.on("mqtt_data", (msg) => {
console.log("pesan data ");
console.log(msg);    
    updateHumidity(msg.data,msg.alarmValue);
}
);


socket.on("alarm", (msg) => {

document.getElementById("alarmValue").textContent = msg
}
);

</script>

  <!-- Bootstrap JS -->
  

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
